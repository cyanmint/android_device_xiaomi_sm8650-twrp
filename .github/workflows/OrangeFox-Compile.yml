name: OrangeFox - Build

# Credits to:
# https://github.com/TeamWin
# https://gitlab.com/OrangeFox
# https://github.com/azwhikaru for Recovery Builder Template
# And all Contributors in every repositories I used

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'OrangeFox Manifest Branch'
        required: true
        default: '14.1'
        type: choice
        options:
        - '14.1'
        - '12.1'
        - '11.0'
      DEVICE_TREE:
        description: 'OrangeFox Device Tree'
        required: true
        default: 'https://github.com/cyanmint/android_device_xiaomi_sm8650-twrp'
      DEVICE_TREE_BRANCH:
        description: 'OrangeFox Device Tree Branch'
        required: true
        default: 'main'
      DEVICE_PATH:
        description: 'Specify your Device Path'
        required: true
        default: 'device/xiaomi/sm8650'
      DEVICE_NAME:
        description: 'Specify your Device Codename'
        required: true
        default: 'ruyi'
      BUILD_TARGET:
        description: 'Specify your Build Target'
        required: true
        default: 'recovery'
        type: choice
        options:
        - boot
        - recovery
        - vendorboot
      DRY_RUN:
        description: 'Dry run mode (test all steps without building)'
        required: true
        default: false
        type: boolean

jobs:
  build:
    name: Build OFR by ${{ github.actor }}
    runs-on: ubuntu-22.04
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    permissions:
      contents: write
    steps:
    - name: Checkout
      uses: actions/checkout@v4
              
    - name: Clean-up
      uses: rokibhasansagar/slimhub_actions@main

    - name: Swap Space
      uses: pierotofy/set-swap-space@master
      with:
        swap-size-gb: 24
      
    - name: Build Environment
      run: |
        sudo apt install aria2 -y
        rm -rf scripts
        git clone https://gitlab.com/OrangeFox/misc/scripts.git -b master
        cd scripts
        sudo bash setup/android_build_env.sh

    - name: Setup ccache
      run: |
        sudo apt-get install -y ccache
        ccache -M 10G
        ccache -z

    - name: Cache OrangeFox Manifest
      id: cache-manifest
      uses: actions/cache@v4
      with:
        path: |
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        key: orangefox-manifest-${{ inputs.MANIFEST_BRANCH }}-v1
        restore-keys: |
          orangefox-manifest-${{ inputs.MANIFEST_BRANCH }}-
      
    - name: Set-up Manifest
      if: (inputs.MANIFEST_BRANCH == '11.0' || inputs.MANIFEST_BRANCH == '12.1' || inputs.MANIFEST_BRANCH == '14.1') && steps.cache-manifest.outputs.cache-hit != 'true'
      run: |
        mkdir -p ${GITHUB_WORKSPACE}/OrangeFox
        cd ${GITHUB_WORKSPACE}/OrangeFox
        
        # Check if cached source exists and is valid
        if [ -d "fox_${{ inputs.MANIFEST_BRANCH }}/.repo" ] && [ -d "fox_${{ inputs.MANIFEST_BRANCH }}/.repo/manifests" ]; then
          echo "Cache found, validating and syncing changes..."
          cd fox_${{ inputs.MANIFEST_BRANCH }}
          if repo sync -c -j$(nproc --all) --no-clone-bundle --no-tags; then
            echo "Incremental sync completed successfully"
          else
            echo "Incremental sync failed, falling back to full sync..."
            cd ${GITHUB_WORKSPACE}/OrangeFox
            rm -rf fox_${{ inputs.MANIFEST_BRANCH }}
            git config --global user.name "${{ github.actor }}"
            git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
            rm -rf sync
            git clone https://gitlab.com/OrangeFox/sync.git -b master
            cd sync
            ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
          fi
        else
          echo "No valid cache found, performing full sync..."
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor_id }}+${{ github.actor }}@users.noreply.github.com"
          rm -rf sync
          git clone https://gitlab.com/OrangeFox/sync.git -b master
          cd sync
          ./orangefox_sync.sh --branch ${{ inputs.MANIFEST_BRANCH }} --path ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        fi

    - name: Clone Device Tree
      run: |
        # Ensure directory exists (needed when cache restores manifest but skips setup step)
        mkdir -p ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        # Remove existing device tree to ensure fresh clone
        rm -rf ./${{ inputs.DEVICE_PATH }}
        git clone ${{ inputs.DEVICE_TREE }} -b ${{ inputs.DEVICE_TREE_BRANCH }} ./${{ inputs.DEVICE_PATH }}
        cd ${{ inputs.DEVICE_PATH }}
        echo "COMMIT_ID=$(git rev-parse HEAD)" >> $GITHUB_ENV

    - name: Cache Build Artifacts
      uses: actions/cache@v4
      with:
        path: |
          ~/.ccache
        key: orangefox-build-${{ inputs.MANIFEST_BRANCH }}-${{ inputs.DEVICE_NAME }}-v1
        restore-keys: |
          orangefox-build-${{ inputs.MANIFEST_BRANCH }}-${{ inputs.DEVICE_NAME }}-
          orangefox-build-${{ inputs.MANIFEST_BRANCH }}-

    - name: Building OrangeFox
      run: |
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}
        set +e
        source build/envsetup.sh
        export ALLOW_MISSING_DEPENDENCIES=true
        export USE_CCACHE=1
        export CCACHE_DIR=~/.ccache
        export CCACHE_EXEC=/usr/bin/ccache
        set -e
        
        # Execute lunch command
        lunch twrp_${{ inputs.DEVICE_NAME }}-eng
        
        # Only run make command if not in dry-run mode
        if [ "${{ inputs.DRY_RUN }}" = "false" ]; then
          echo "=== Building OrangeFox ==="
          # Note: 'make clean' intentionally omitted to leverage ccache and enable incremental builds
          mka adbd ${{ inputs.BUILD_TARGET }}image
        else
          echo "=== DRY RUN MODE - Skipping build ==="
          echo "All setup completed successfully. Build command would be:"
          echo "mka adbd ${{ inputs.BUILD_TARGET }}image"
          echo ""
          echo "✓ Build environment configured"
          echo "✓ Device tree verified at ${{ inputs.DEVICE_PATH }}"
          echo "✓ Lunch command executed for twrp_${{ inputs.DEVICE_NAME }}-eng"
          echo "✓ Ready to build fox_${{ inputs.MANIFEST_BRANCH }}"
        fi

    - name: Upload Artifacts
      if: inputs.DRY_RUN == false
      uses: actions/upload-artifact@v4
      with:
        name: OrangeFox-${{ inputs.DEVICE_NAME }}-${{ github.run_id }}
        path: |
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.img
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.zip
        retention-days: 30
        if-no-files-found: warn

    - name: Set Release Properties
      if: inputs.DRY_RUN == false
      run: |
        echo "BUILD_DATE=$(TZ=Asia/Manila date +%Y%m%d)" >> $GITHUB_ENV
        cd ${GITHUB_WORKSPACE}/OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}

        DEVICE_TREE_URL="${{ inputs.DEVICE_TREE }}"
        if [[ "${DEVICE_TREE_URL}" == *.git ]]; then
          DEVICE_TREE_URL="${DEVICE_TREE_URL%.git}"
        fi
        echo "DEVICE_TREE_URL=${DEVICE_TREE_URL}" >> $GITHUB_ENV

    - name: Upload to Release
      if: inputs.DRY_RUN == false
      uses: softprops/action-gh-release@v2
      with:
        files: |
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.img
          OrangeFox/fox_${{ inputs.MANIFEST_BRANCH }}/out/target/product/${{ inputs.DEVICE_NAME }}/OrangeFox*.zip
        name: OrangeFox Recovery for ${{ inputs.DEVICE_NAME }} // ${{ env.BUILD_DATE }}
        tag_name: ${{ github.run_id }}
        body: |
          ## OrangeFox Recovery Build - Unofficial
          Build: fox_${{ inputs.MANIFEST_BRANCH }}
          Device: [Device Tree/Branch](${{ env.DEVICE_TREE_URL }}/tree/${{ inputs.DEVICE_TREE_BRANCH }})
          Commit: Most recent [commit](${{ env.DEVICE_TREE_URL }}/commit/${{ env.COMMIT_ID }}) during building.
          
    - name: Dry Run Summary
      if: inputs.DRY_RUN == true
      run: |
        echo "# Dry Run Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ✅ All steps verified successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Configuration:" >> $GITHUB_STEP_SUMMARY
        echo "- **Manifest Branch**: fox_${{ inputs.MANIFEST_BRANCH }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Device Name**: ${{ inputs.DEVICE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Device Path**: ${{ inputs.DEVICE_PATH }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Build Target**: ${{ inputs.BUILD_TARGET }}image" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Verified Steps:" >> $GITHUB_STEP_SUMMARY
        echo "1. ✓ Build environment setup" >> $GITHUB_STEP_SUMMARY
        echo "2. ✓ OrangeFox manifest sync (fox_${{ inputs.MANIFEST_BRANCH }})" >> $GITHUB_STEP_SUMMARY
        echo "3. ✓ Device tree clone" >> $GITHUB_STEP_SUMMARY
        echo "4. ✓ Device makefile validation" >> $GITHUB_STEP_SUMMARY
        echo "5. ✓ Lunch command execution" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**The workflow is ready to build. Set DRY_RUN to false to perform actual build.**" >> $GITHUB_STEP_SUMMARY

